# simple-go
Simple Lab running k3s(raspberrypi cluster) to test an app(go), docker(build/push), kubernetes(deploy) and Jenkins pipeline.

## Environment
```
1 x Raspberry Pi3 1GB (192.168.1.118)
1 x Raspberry Pi4 4GB (192.168.1.181)
1 x Raspberry Pi4 8GB (192.168.1.185)
```
* Metallb + Ingress nginx
* DNS *.rlab.carlosmalucelli.com (pointing to IP(generated by metallb) of ingress)

k3s
* Master (k8s01 - Raspberry Pi4 4gb)
* Worker (k8s02 - Raspberry Pi4 8gb)

```
$ kubectl get nodes
NAME    STATUS   ROLES    AGE   VERSION
k8s01   Ready    master   89d   v1.18.2+k3s1
k8s02   Ready    <none>   89d   v1.18.2+k3s1

$ kubectl top nodes
NAME    CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%
k8s01   1924m        48%    867Mi           22%
k8s02   553m         13%    841Mi           10%
```

Jenkins
* Raspberry Pi3 1GB

Jenkins Agent
* Raspberry Pi4 8GB (Responsible for build docker images)

Docker registry 
* Raspberry Pi3 1GB


![Image Alt](https://raw.githubusercontent.com/nopp/simple-go/master/.img/raspCluster.jpg)

## App
* Go with mux
* DNS simplego.rlab.carlosmalucelli.com

## Jenkins Pipeline

![Image Alt](https://raw.githubusercontent.com/nopp/simple-go/master/.img/jenkins.png)


## Output from pipeline ;)

```
[Pipeline] Start of Pipeline
[Pipeline] node
Running on raspberrypi-8gb in /ansible/workspace/Simple-go
[Pipeline] {
[Pipeline] stage (hide)
[Pipeline] { (Pull Repository)
[Pipeline] git
The recommended git tool is: NONE
No credentials specified
Fetching changes from the remote Git repository
 > git rev-parse --is-inside-work-tree # timeout=10
 > git config remote.origin.url https://github.com/nopp/simple-go.git # timeout=10
Fetching upstream changes from https://github.com/nopp/simple-go.git
 > git --version # timeout=10
 > git --version # 'git version 2.20.1'
 > git fetch --tags --force --progress -- https://github.com/nopp/simple-go.git +refs/heads/*:refs/remotes/origin/* # timeout=10
Checking out Revision 36017c0d838fe80460c1ca5cbad2ed7cf2ab8031 (refs/remotes/origin/master)
Commit message: "Update app.go"
 > git rev-parse refs/remotes/origin/master^{commit} # timeout=10
 > git rev-parse refs/remotes/origin/origin/master^{commit} # timeout=10
 > git config core.sparsecheckout # timeout=10
 > git checkout -f 36017c0d838fe80460c1ca5cbad2ed7cf2ab8031 # timeout=10
 > git branch -a -v --no-abbrev # timeout=10
 > git branch -D master # timeout=10
 > git checkout -b master 36017c0d838fe80460c1ca5cbad2ed7cf2ab8031 # timeout=10
 > git rev-list --no-walk 6c6525b1a736b1927ff5d216b658050a2f155157 # timeout=10
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Git checkout tag)
[Pipeline] sh
+ git checkout 1.0
Note: checking out '1.0'.
HEAD is now at c6504de Update app.go
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Unit test)
[Pipeline] sh
+ go test -v
=== RUN   TestGetVersion
--- PASS: TestGetVersion (0.00s)
=== RUN   TestGetRoot
--- PASS: TestGetRoot (0.01s)
PASS
ok  	simple-go	0.027s
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Build Docker Imge)
[Pipeline] sh
+ docker build -t registry.carlosmalucelli.com/simple-go:1.0 .
Sending build context to Docker daemon  3.663MB

Step 1/4 : FROM golang:1.14
 ---> d5a553a9a71e
Step 2/4 : COPY . .
 ---> f21707f0b1d1
Step 3/4 : RUN unset GOPATH     && go build -o main .
 ---> Running in f959899ae340
downloading github.com/gorilla/mux v1.8.0
Removing intermediate container f959899ae340
 ---> ca4bcc901d76
Step 4/4 : ENTRYPOINT ["./main"]
 ---> Running in 71a9e7681567
Removing intermediate container 71a9e7681567
 ---> 319fd8997029
Successfully built 319fd8997029
Successfully tagged registry.carlosmalucelli.com/simple-go:1.0
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Push Docker Imge)
[Pipeline] sh
+ docker push registry.carlosmalucelli.com/simple-go:1.0
The push refers to repository [registry.carlosmalucelli.com/simple-go]
5a9523d58f6e: Preparing
04f3e9e11cce: Preparing
5bc3988dfdc4: Preparing
4d4ff09cedf8: Preparing
b90d1e309087: Preparing
5d41b2315360: Preparing
02beba293b78: Preparing
b8676a7dda39: Preparing
07aaf212e4f3: Preparing
02beba293b78: Waiting
b8676a7dda39: Waiting
07aaf212e4f3: Waiting
5d41b2315360: Waiting
5bc3988dfdc4: Layer already exists
4d4ff09cedf8: Layer already exists
b90d1e309087: Layer already exists
b8676a7dda39: Layer already exists
02beba293b78: Layer already exists
5d41b2315360: Layer already exists
07aaf212e4f3: Layer already exists
04f3e9e11cce: Pushed
5a9523d58f6e: Pushed
1.0: digest: sha256:e9448af4442a9813875460d864ec322fe4c128e90d04c7adb35719dd44b059d7 size: 2217
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Kubernetes apply ingress)
[Pipeline] sh
+ kubectl apply -f k8s/ingress.yaml
ingress.networking.k8s.io/ingress-nginx configured
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Kubernetes apply service)
[Pipeline] sh
+ kubectl apply -f k8s/service.yaml
service/simple-go-svc unchanged
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Change tag version on deployment)
[Pipeline] sh
+ sed -i s/XXVERSIONXX/1.0/g k8s/deploy.yaml
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Kubernetes apply deployment)
[Pipeline] sh
+ kubectl apply -f k8s/deploy.yaml
deployment.apps/simple-go configured
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Kubernetes rollout status)
[Pipeline] sh
+ kubectl rollout status deploy simple-go --timeout=300s
Waiting for deployment "simple-go" rollout to finish: 1 old replicas are pending termination...
Waiting for deployment "simple-go" rollout to finish: 1 old replicas are pending termination...
deployment "simple-go" successfully rolled out
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
[Pipeline] // node
[Pipeline] End of Pipeline
Finished: SUCCESS
```
